<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loot Beast — Gallery</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@400;600&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet"/>
  <style>
    :root{--gold:#c9a84c;--gold2:#f0d070;--dark:#0a0806;--dark2:#13100a;--dark3:#1e1810;--red:#8b1a1a;--red2:#c0392b;--text:#e8dcc8;--muted:#7a6a50;--border:#2e2416;--blue:#4a9eff;--green:#4caf50}
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--dark);color:var(--text);font-family:'Cinzel',serif;min-height:100vh;overflow-x:hidden}
    body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 60% at 50% 0%,rgba(139,26,26,.18) 0%,transparent 70%),radial-gradient(ellipse 60% 40% at 80% 100%,rgba(201,168,76,.08) 0%,transparent 60%);pointer-events:none;z-index:0}
    header{position:relative;z-index:10;text-align:center;padding:3.5rem 2rem 2rem;border-bottom:1px solid var(--border)}
    .emblem{font-size:3.5rem;margin-bottom:.5rem;animation:glow 3s ease-in-out infinite}
    @keyframes glow{0%,100%{filter:drop-shadow(0 0 18px rgba(201,168,76,.4))}50%{filter:drop-shadow(0 0 36px rgba(201,168,76,.8))}}
    h1{font-family:'Cinzel Decorative',serif;font-size:clamp(1.8rem,5vw,3.2rem);font-weight:900;background:linear-gradient(135deg,var(--gold),var(--gold2),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:.04em}
    .subtitle{font-family:'IM Fell English',serif;font-style:italic;color:var(--muted);font-size:1rem;margin-top:.4rem;letter-spacing:.06em}
    .contract-badge{display:inline-block;margin-top:1rem;padding:.3rem 1rem;border:1px solid var(--border);font-size:.7rem;color:var(--muted);letter-spacing:.08em;background:rgba(255,255,255,.02)}
    .connect-area{position:relative;z-index:10;display:flex;flex-direction:column;align-items:center;gap:.8rem;padding:2.5rem 2rem}
    #connect-btn{font-family:'Cinzel',serif;font-weight:600;font-size:.9rem;letter-spacing:.12em;text-transform:uppercase;padding:.9rem 2.8rem;background:transparent;border:1px solid var(--gold);color:var(--gold);cursor:pointer;transition:all .3s;clip-path:polygon(12px 0%,100% 0%,calc(100% - 12px) 100%,0% 100%);position:relative}
    #connect-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(201,168,76,.15),transparent);opacity:0;transition:opacity .3s}
    #connect-btn:hover{color:var(--gold2);border-color:var(--gold2)}#connect-btn:hover::before{opacity:1}#connect-btn:disabled{opacity:.4;cursor:not-allowed}
    #wallet-info{font-family:'IM Fell English',serif;font-style:italic;font-size:.85rem;color:var(--muted);display:none}#wallet-info.visible{display:block}
    #status{position:relative;z-index:10;text-align:center;padding:0 2rem 1.5rem;font-family:'IM Fell English',serif;font-style:italic;font-size:.95rem;color:var(--muted);min-height:2rem}
    #status.error{color:var(--red2)}

    /* Mint panel */
    .mint-section{position:relative;z-index:10;max-width:560px;margin:0 auto 2rem;padding:0 2rem;display:none}
    .mint-section.visible{display:block}
    .mint-panel{border:1px solid var(--border);background:var(--dark2);padding:2rem;position:relative;overflow:hidden}
    .mint-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--red),var(--gold),var(--red),transparent)}
    .mint-title{font-family:'Cinzel Decorative',serif;font-size:1rem;color:var(--gold);text-align:center;margin-bottom:1.5rem;letter-spacing:.06em}
    .mint-preview{display:flex;gap:1.2rem;align-items:flex-start;margin-bottom:1.5rem;padding:1rem;background:var(--dark3);border:1px solid var(--border)}
    .mint-preview-art{width:90px;height:90px;flex-shrink:0;overflow:hidden}
    .mint-preview-art img{width:100%;height:100%;object-fit:cover;display:block}
    .mint-preview-name{font-family:'Cinzel Decorative',serif;font-size:.75rem;color:var(--gold);margin-bottom:.6rem;line-height:1.4}
    .mint-preview-stats{display:grid;grid-template-columns:1fr 1fr;gap:.3rem .8rem}
    .mini-stat{font-size:.65rem;color:var(--muted)}.mini-stat span{color:var(--text);margin-left:.3rem}
    .mint-actions{display:flex;gap:.8rem}
    #reroll-btn{font-family:'Cinzel',serif;font-size:.75rem;letter-spacing:.1em;text-transform:uppercase;padding:.7rem 1.2rem;background:transparent;border:1px solid var(--border);color:var(--muted);cursor:pointer;transition:all .3s;flex-shrink:0}
    #reroll-btn:hover{border-color:var(--gold);color:var(--gold)}
    #mint-btn{font-family:'Cinzel',serif;font-weight:600;font-size:.85rem;letter-spacing:.12em;text-transform:uppercase;padding:.8rem 0;background:linear-gradient(135deg,var(--red),#6b1212);border:1px solid var(--red);color:var(--text);cursor:pointer;flex:1;transition:all .3s;clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%);position:relative;overflow:hidden}
    #mint-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(201,168,76,.2),transparent);opacity:0;transition:opacity .3s}
    #mint-btn:hover::before{opacity:1}#mint-btn:hover{border-color:var(--gold)}#mint-btn:disabled{opacity:.4;cursor:not-allowed}
    #mint-status{margin-top:1rem;font-family:'IM Fell English',serif;font-style:italic;font-size:.85rem;color:var(--muted);text-align:center;min-height:1.4rem}
    #mint-status.error{color:var(--red2)}#mint-status.success{color:var(--green)}
    .shiny-chance{font-size:.65rem;color:var(--muted);text-align:center;margin-top:.8rem;letter-spacing:.08em}

    /* Divider */
    .divider{position:relative;z-index:10;display:none;align-items:center;gap:1rem;padding:0 2.5rem;margin:.5rem auto 1.5rem;max-width:1400px}
    .divider.visible{display:flex}.divider-line{flex:1;height:1px;background:var(--border)}
    .divider-text{font-size:.7rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;white-space:nowrap}

    /* Gallery */
    #gallery{position:relative;z-index:10;display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.8rem;padding:1rem 2.5rem 4rem;max-width:1400px;margin:0 auto}
    .beast-card{background:var(--dark2);border:1px solid var(--border);position:relative;overflow:hidden;transition:transform .3s,border-color .3s;animation:card-in .5s ease both}
    @keyframes card-in{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .beast-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:0;transition:opacity .3s}
    .beast-card:hover{transform:translateY(-4px);border-color:var(--gold)}.beast-card:hover::before{opacity:1}

    /* Locked card style */
    .beast-card.is-locked{border-color:#3a3060}
    .beast-card.is-locked::before{background:linear-gradient(90deg,transparent,var(--blue),transparent);opacity:1}

    .beast-art{width:100%;aspect-ratio:1;background:var(--dark3);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
    .beast-art img{width:100%;height:100%;object-fit:cover;display:block}
    .beast-card.shiny .beast-art::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 30%,rgba(201,168,76,.15) 50%,transparent 70%);animation:shimmer 3s ease-in-out infinite}
    @keyframes shimmer{0%{transform:translateX(-100%) rotate(30deg)}100%{transform:translateX(200%) rotate(30deg)}}

    /* Lock overlay on art */
    .lock-overlay{position:absolute;inset:0;background:rgba(10,8,30,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;transition:opacity .3s;backdrop-filter:blur(2px)}
    .beast-card.is-locked .lock-overlay{opacity:1}
    .lock-icon{font-size:2.5rem;margin-bottom:.4rem}
    .lock-label{font-size:.65rem;letter-spacing:.2em;text-transform:uppercase;color:var(--blue)}

    .beast-info{padding:1.2rem 1.4rem 1rem}
    .beast-token-id{font-size:.65rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-bottom:.3rem}
    .beast-name{font-family:'Cinzel Decorative',serif;font-size:.95rem;color:var(--gold);margin-bottom:1rem;line-height:1.3}
    .beast-stats{display:grid;grid-template-columns:1fr 1fr;gap:.5rem 1rem}
    .stat{display:flex;flex-direction:column;gap:.15rem}
    .stat-label{font-size:.6rem;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
    .stat-value{font-family:'IM Fell English',serif;font-size:1rem;color:var(--text)}
    .stat-bar{height:2px;background:var(--border);margin-top:.2rem;position:relative;overflow:hidden}
    .stat-bar-fill{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,var(--red),var(--gold))}
    .badges{display:flex;gap:.4rem;margin-top:.9rem;flex-wrap:wrap}
    .badge{font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;padding:.2rem .6rem;border:1px solid var(--border);color:var(--muted)}
    .badge.shiny{border-color:var(--gold);color:var(--gold)}.badge.animated{border-color:var(--blue);color:var(--blue)}
    .badge.locked{border-color:var(--blue);color:var(--blue);background:rgba(74,158,255,.08)}

    /* Lock/Unlock button on card */
    .card-actions{padding:.8rem 1.4rem 1.2rem;border-top:1px solid var(--border);display:flex;gap:.6rem;align-items:center}
    .lock-btn{font-family:'Cinzel',serif;font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;padding:.5rem 1rem;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;transition:all .25s;flex:1}
    .lock-btn:hover:not(:disabled){border-color:var(--blue);color:var(--blue)}
    .lock-btn.unlock-btn:hover:not(:disabled){border-color:var(--green);color:var(--green)}
    .lock-btn:disabled{opacity:.35;cursor:not-allowed}
    .card-status{font-family:'IM Fell English',serif;font-style:italic;font-size:.7rem;color:var(--muted);flex:1;text-align:right}
    .card-status.ok{color:var(--green)}.card-status.err{color:var(--red2)}

    #empty{display:none;position:relative;z-index:10;text-align:center;padding:5rem 2rem}
    #empty.visible{display:block}.empty-icon{font-size:4rem;margin-bottom:1.5rem;opacity:.3}
    .empty-text{font-family:'IM Fell English',serif;font-style:italic;color:var(--muted);font-size:1.1rem}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;vertical-align:middle;margin-right:.5rem}
    @keyframes spin{to{transform:rotate(360deg)}}
    footer{position:relative;z-index:10;text-align:center;padding:2rem;border-top:1px solid var(--border);font-size:.7rem;color:var(--muted);letter-spacing:.1em}
    footer a{color:var(--gold);text-decoration:none}footer a:hover{color:var(--gold2)}
  </style>
</head>
<body>
<header>
  <div class="emblem">&#x1F409;</div>
  <h1>Loot Beast</h1>
  <p class="subtitle">Creatures of the Dungeon &mdash; Starknet Sepolia</p>
  <div class="contract-badge">NFT &middot; 0x0471e7df&hellip;e0a15 &nbsp;|&nbsp; VAULT &middot; 0x027d9dd7&hellip;034e</div>
</header>
<div class="connect-area">
  <button id="connect-btn">&#x2694; Connect Wallet</button>
  <div id="wallet-info"></div>
</div>
<div id="status"></div>

<!-- Mint panel -->
<div class="mint-section" id="mint-section">
  <div class="mint-panel">
    <div class="mint-title">&#x2694; Summon a Beast</div>
    <div class="mint-preview">
      <div class="mint-preview-art"><img id="preview-img" src="" alt="Preview"/></div>
      <div>
        <div class="mint-preview-name" id="preview-name">Roll to reveal&hellip;</div>
        <div class="mint-preview-stats" id="preview-stats"></div>
      </div>
    </div>
    <div class="mint-actions">
      <button id="reroll-btn">&#x1F3B2; Reroll</button>
      <button id="mint-btn">Summon Beast</button>
    </div>
    <div id="mint-status"></div>
    <p class="shiny-chance">&#x2726; 5% Shiny &middot; 10% Animated</p>
  </div>
</div>

<div class="divider" id="gallery-divider">
  <div class="divider-line"></div>
  <span class="divider-text" id="beast-count">Your Beasts</span>
  <div class="divider-line"></div>
</div>
<div id="gallery"></div>
<div id="empty">
  <div class="empty-icon">&#x1F5E1;</div>
  <p class="empty-text">No beasts found in this wallet.<br/>Summon one above to begin.</p>
</div>
<footer>
  Built on <a href="https://starknet.io" target="_blank">Starknet</a> &middot;
  <a href="https://sepolia.voyager.online/contract/0x0471e7df1c7af2c049326eb838b2760e9749adf5138afff20dc1439dde6e0a15" target="_blank">NFT on Voyager</a> &middot;
  <a href="https://sepolia.voyager.online/contract/0x027d9dd74e2b39b8da20ccfeccf9c15bdbfa41a8ae0b3b303c0b2af0b897034e" target="_blank">Vault on Voyager</a>
</footer>

<script>
  const NFT_CONTRACT   = "0x0471e7df1c7af2c049326eb838b2760e9749adf5138afff20dc1439dde6e0a15";
  const VAULT_CONTRACT = "0x027d9dd74e2b39b8da20ccfeccf9c15bdbfa41a8ae0b3b303c0b2af0b897034e";
  // Replace with your Alchemy key
  const RPC_URL        = "https://starknet-sepolia.g.alchemy.com/starknet/version/rpc/v0_10/CJMHx8Zr5oQbMTXXvtxfY";

  const TRANSFER_KEY = "0x0099cd8bde557814842a3121e8ddfd433a539b8c9f14bf31ebf108d12e6196e9";

  // approve(spender, token_id_low, token_id_high)
  const APPROVE_SEL  = "0x0219209e083275171774dab1df80982e9df2096516f06319c5c6d71ae0a8480c";
  // vault lock(token_id_low, token_id_high)
  const LOCK_SEL     = "0x03f461fb3cdd7ba87790dfdb0ecf8d6db24f9c7bafb9f1e6a2b6d1a09c7adcf9";
  // vault is_locked(token_id_low, token_id_high)
  const IS_LOCKED_SEL= "0x011a8b2d9b4f79e47be56862bff2c57f3e6b30e7c8f2b17a01d6e5a42ed7e4c8";

  const BEAST_NAMES = ["","Warlock","Typhon","Jiangshi","Anansi","Basilisk","Gorgon","Kitsune","Lich","Chimera","Wendigo","Rakshasa","Werewolf","Banshee","Draugr","Vampire","Goblin","Skeleton","Orc","Revenant","Ghoul","Pixie","Gnome","Djinn","Fairy","Leprechaun","Kelpie","Sprite","Medusa","Jotunn","Minotaur","Kraken","Colossus","Balrog","Leviathan","Tarrasque","Titan","Nephilim","Behemoth","Hydra","Juggernaut","Fenrir","Ammit","Ifrit","Oni","Nue","Skinwalker","Chupacabra","Weretiger","Wyvern","Roc","Harpy","Pegasus","Hippogriff","Manticore","Cockatrice"];
  const PREFIXES = ["","Agony","Apocalypse","Armageddon","Beast","Behemoth","Blight","Blood","Bramble","Brimstone","Brood","Carrion","Cataclysm","Chimeric","Corpse","Corruption","Damnation","Death","Demon","Dire","Dragon","Dread","Doom","Dusk","Elder","Ember","Ethereal","Evil","Fallen","Feral","Grave","Grim","Hate","Havoc","Horror","Hypnotic","Loath","Malice","Morbid","Oblivion","Onslaught","Pain","Pandemonium","Phantom","Plague","Rage","Rune","Skull","Soul","Sorrow","Spirit","Storm","Tempest","Terror","Shadow","Unholy","Vengeance","Vile","Void","Woe","Wrath"];
  const SUFFIXES = ["","of Power","of Giants","of Titans","of Skill","of Perfection","of Brilliance","of Enlightenment","of Protection","of Anger","of Rage","of Fury","of Vitriol","of the Fox","of Detection","of Reflection","of the Twins","of Devastation","of Slaughter","of Sorrow","of Ruin","of Death","of Blight","of Dread"];
  const EMOJIS = {1:"&#x1F9D9;",2:"&#x1F300;",3:"&#x1F47B;",4:"&#x1F577;",5:"&#x1F40D;",6:"&#x1F98E;",7:"&#x1F98A;",8:"&#x1F480;",9:"&#x1F525;",10:"&#x2744;",11:"&#x1F43A;",12:"&#x1F982;",14:"&#x1F441;",15:"&#x2620;",16:"&#x1F9DB;",17:"&#x1F47A;",19:"&#x1F479;",20:"&#x1F9DF;",default:"&#x1F409;"};

  function shortAddr(a){return a.slice(0,6)+"..."+a.slice(-4)}
  function beastLabel(id,p,s){return [PREFIXES[p]||"",BEAST_NAMES[id]||("Beast #"+id),SUFFIXES[s]||""].filter(Boolean).join(" ")}
  function toHex(n){return "0x"+BigInt(n).toString(16)}
  function padHex(n){return "0x"+BigInt(n).toString(16).padStart(64,"0")}
  function normAddr(a){return "0x"+a.toLowerCase().replace("0x","").padStart(64,"0")}
  function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a}

  async function rpc(method,params){
    const r=await fetch(RPC_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:1,method,params})});
    const d=await r.json();
    if(d.error)throw new Error(d.error.message);
    return d.result;
  }

  async function callContract(contract,selector,calldata=[]){
    return rpc("starknet_call",{request:{contract_address:contract,entry_point_selector:selector,calldata},block_id:"latest"});
  }

  // Check vault lock status for a token
  async function checkIsLocked(tokenId){
    try{
      const res=await callContract(VAULT_CONTRACT,IS_LOCKED_SEL,[padHex(tokenId),"0x0"]);
      return res&&res[0]==="0x1";
    }catch(e){return false;}
  }

  // ── Fetch owned tokens via Transfer events ────────────────────────────────
  async function fetchOwnedTokens(ownerAddress){
    const myNorm=normAddr(ownerAddress);
    const zero="0x"+"0".repeat(64);
    const ownership={};

    // Step 1: all mint events build initial ownership map
    try{
      let ct=null;
      do{
        const filter={from_block:{block_number:0},to_block:"latest",address:NFT_CONTRACT,keys:[[TRANSFER_KEY],[zero]],chunk_size:1000};
        if(ct)filter.continuation_token=ct;
        const res=await rpc("starknet_getEvents",{filter});
        for(const ev of (res.events||[])){
          const to=normAddr(ev.keys[2]||"0x0");
          const tokenId=BigInt(ev.keys[3]||"0x0").toString();
          if(tokenId!=="0")ownership[tokenId]=to;
        }
        ct=res.continuation_token||null;
      }while(ct);
    }catch(e){console.warn("Mint events:",e.message);}

    // Step 2: all transfers FROM me update ownership (covers sending to vault or others)
    try{
      let ct=null;
      do{
        const filter={from_block:{block_number:0},to_block:"latest",address:NFT_CONTRACT,keys:[[TRANSFER_KEY],[myNorm]],chunk_size:1000};
        if(ct)filter.continuation_token=ct;
        const res=await rpc("starknet_getEvents",{filter});
        for(const ev of (res.events||[])){
          const to=normAddr(ev.keys[2]||"0x0");
          const tokenId=BigInt(ev.keys[3]||"0x0").toString();
          if(tokenId!=="0")ownership[tokenId]=to;
        }
        ct=res.continuation_token||null;
      }while(ct);
    }catch(e){console.warn("Transfer-out:",e.message);}

    // Step 3: anything now sitting at vault address = locked by me
    const vaultNorm=normAddr(VAULT_CONTRACT);
    return Object.entries(ownership)
      .filter(([,owner])=>owner===myNorm||owner===vaultNorm)
      .map(([id,owner])=>({id,locked:owner===vaultNorm}));
  }

  // get_beast
  const GET_BEAST_SELS=["0x01a3cd89e72b5e5d9b3a25de7b4a4d41ade5eddc0b42c7b37b7afba61d2d8e4f","0x029ce0933f3f6dd0c5c0a45a7fc87fb96a12af73da5f0da07ead96a9cab8da96"];
  async function getBeastData(tokenId){
    for(const sel of GET_BEAST_SELS){
      try{
        const res=await callContract(NFT_CONTRACT,sel,[padHex(tokenId),"0x0"]);
        if(res&&res.length>=7)return{id:parseInt(res[0],16),prefix:parseInt(res[1],16),suffix:parseInt(res[2],16),level:parseInt(res[3],16),health:parseInt(res[4],16),shiny:parseInt(res[5],16),animated:parseInt(res[6],16)};
      }catch(e){}
    }
    const s=parseInt(tokenId);
    return{id:(s%55)+1,prefix:s%PREFIXES.length,suffix:s%SUFFIXES.length,level:(s%50)+1,health:(s%950)+50,shiny:0,animated:0};
  }

  // SVG art
  function makeSVG(beast,tokenId){
    const shiny=beast.shiny==1,accent=shiny?"#c9a84c":"#8b1a1a",bg=shiny?"#1a1500":"#0e0b08";
    const hpW=Math.round(Math.min(beast.health,1000)/1000*180);
    const emoji=EMOJIS[beast.id]||EMOJIS.default;
    return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 300">'
      +'<defs><radialGradient id="g'+tokenId+'" cx="50%" cy="40%" r="60%"><stop offset="0%" stop-color="'+accent+'" stop-opacity="0.3"/><stop offset="100%" stop-color="'+bg+'"/></radialGradient>'
      +'<filter id="f'+tokenId+'"><feGaussianBlur stdDeviation="5" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>'
      +'<rect width="300" height="300" fill="url(#g'+tokenId+')"/>'
      +'<rect x="1" y="1" width="298" height="298" fill="none" stroke="'+accent+'" stroke-width="0.5" opacity="0.5"/>'
      +'<line x1="0" y1="20" x2="20" y2="0" stroke="'+accent+'" stroke-width="1" opacity="0.6"/>'
      +'<line x1="280" y1="0" x2="300" y2="20" stroke="'+accent+'" stroke-width="1" opacity="0.6"/>'
      +'<line x1="0" y1="280" x2="20" y2="300" stroke="'+accent+'" stroke-width="1" opacity="0.6"/>'
      +'<line x1="280" y1="300" x2="300" y2="280" stroke="'+accent+'" stroke-width="1" opacity="0.6"/>'
      +'<text x="150" y="42" font-family="serif" font-size="10" fill="'+accent+'" text-anchor="middle" letter-spacing="3" opacity="0.9">BEAST #'+tokenId+'</text>'
      +'<text x="150" y="62" font-family="serif" font-size="9" fill="#7a6a50" text-anchor="middle" letter-spacing="2">LVL '+beast.level+'</text>'
      +'<text x="150" y="178" font-size="90" text-anchor="middle" filter="url(#f'+tokenId+')" font-family="serif">'+emoji+'</text>'
      +'<rect x="60" y="242" width="180" height="3" fill="#1e1810" rx="1"/>'
      +'<rect x="60" y="242" width="'+hpW+'" height="3" fill="'+accent+'" rx="1"/>'
      +'<text x="60" y="258" font-family="serif" font-size="8" fill="#7a6a50">HP '+beast.health+'</text>'
      +(shiny?'<text x="240" y="258" font-family="serif" font-size="9" fill="#c9a84c" text-anchor="end">SHINY</text>':'')
      +(beast.animated==1?'<text x="240" y="258" font-family="serif" font-size="9" fill="#4a9eff" text-anchor="end">GIF</text>':'')
      +'</svg>';
  }

  let walletProvider=null,walletAddress=null,pendingBeast=null;

  // ── Sync locked beast to Supabase via API ─────────────────────────────────────
  async function syncBeastToAPI(tokenId, beast) {
    try {
      await fetch("https://ftd-backend.vercel.app/api/beasts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token_id:  parseInt(tokenId),
          owner:     walletAddress,
          name:      beastLabel(beast.id, beast.prefix, beast.suffix),
          beast_id:  beast.id,
          prefix:    beast.prefix,
          suffix:    beast.suffix,
          level:     beast.level,
          health:    beast.health,
          shiny:     beast.shiny === 1,
          animated:  beast.animated === 1,
          is_locked: true,
          locked_at: new Date().toISOString(),
        }),
      });
      console.log("Beast synced to API:", tokenId);
    } catch(e) {
      console.warn("API sync failed (non-critical):", e.message);
    }
  }

  // ── Lock a beast (approve + lock in one multicall) ────────────────────────
  async function lockBeast(tokenId,btn,statusEl){
    const account=walletProvider.account;
    if(!account)throw new Error("No account");
    btn.disabled=true;btn.textContent="Locking...";
    statusEl.className="card-status";statusEl.textContent="Awaiting wallet...";
    try{
      // Multicall: approve vault, then lock
      const result=await account.execute([
        {
          contractAddress:NFT_CONTRACT,
          entrypoint:"approve",
          calldata:[VAULT_CONTRACT,toHex(tokenId),"0x0"],
        },
        {
          contractAddress:VAULT_CONTRACT,
          entrypoint:"lock",
          calldata:[toHex(tokenId),"0x0"],
        },
      ]);
      statusEl.className="card-status ok";
      statusEl.innerHTML='<a href="https://sepolia.voyager.online/tx/'+result.transaction_hash+'" target="_blank" style="color:var(--green)">Locked!</a>';
      // Sync beast data to API
      const beastData = await getBeastData(tokenId);
      syncBeastToAPI(tokenId, beastData);
      // Update card visually
      const card=btn.closest(".beast-card");
      card.classList.add("is-locked");
      btn.textContent="&#x1F513; Unlock";
      btn.className="lock-btn unlock-btn";
      btn.disabled=false;
      btn.onclick=()=>unlockBeast(tokenId,btn,statusEl);
      // Update badge
      const badges=card.querySelector(".badges");
      if(!badges.querySelector(".badge.locked")){
        const b=document.createElement("span");
        b.className="badge locked";b.textContent="Locked";
        badges.appendChild(b);
      }
    }catch(err){
      statusEl.className="card-status err";statusEl.textContent=err.message.slice(0,40);
      btn.disabled=false;btn.textContent="&#x1F512; Lock";
    }
  }

  // ── Unlock — only vault owner can do this ─────────────────────────────────
  async function unlockBeast(tokenId,btn,statusEl){
    const account=walletProvider.account;
    if(!account)throw new Error("No account");
    btn.disabled=true;btn.textContent="Releasing...";
    statusEl.className="card-status";statusEl.textContent="Awaiting wallet...";
    try{
      // release(token_id_low, token_id_high, to_address)
      const result=await account.execute({
        contractAddress:VAULT_CONTRACT,
        entrypoint:"release",
        calldata:[toHex(tokenId),"0x0",walletAddress],
      });
      statusEl.className="card-status ok";
      statusEl.innerHTML='<a href="https://sepolia.voyager.online/tx/'+result.transaction_hash+'" target="_blank" style="color:var(--green)">Released!</a>';
      const card=btn.closest(".beast-card");
      card.classList.remove("is-locked");
      btn.textContent="&#x1F512; Lock";
      btn.className="lock-btn";
      btn.disabled=false;
      btn.onclick=()=>lockBeast(tokenId,btn,statusEl);
      const lockedBadge=card.querySelector(".badge.locked");
      if(lockedBadge)lockedBadge.remove();
    }catch(err){
      statusEl.className="card-status err";statusEl.textContent=err.message.slice(0,40);
      btn.disabled=false;btn.textContent="&#x1F513; Unlock";
    }
  }

  // ── Render card ───────────────────────────────────────────────────────────
  function renderCard(tokenId,beast,isLocked,idx){
    const name=beastLabel(beast.id,beast.prefix,beast.suffix);
    const svgUrl="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(makeSVG(beast,tokenId));
    const card=document.createElement("div");
    card.className="beast-card"+(beast.shiny==1?" shiny":"")+(isLocked?" is-locked":"");
    card.style.animationDelay=(idx*.08)+"s";

    const lockBtnHtml=isLocked
      ?'<button class="lock-btn unlock-btn">&#x1F513; Unlock</button>'
      :'<button class="lock-btn">&#x1F512; Lock</button>';

    card.innerHTML=
      '<div class="beast-art">'
        +'<img src="'+svgUrl+'" alt="'+name+'"/>'
        +'<div class="lock-overlay"><div class="lock-icon">&#x1F512;</div><div class="lock-label">Locked in Vault</div></div>'
      +'</div>'
      +'<div class="beast-info">'
        +'<div class="beast-token-id">Token #'+tokenId+'</div>'
        +'<div class="beast-name">'+name+'</div>'
        +'<div class="beast-stats">'
          +'<div class="stat"><span class="stat-label">Level</span><span class="stat-value">'+beast.level+'</span></div>'
          +'<div class="stat"><span class="stat-label">Health</span><span class="stat-value">'+beast.health+'</span>'
            +'<div class="stat-bar"><div class="stat-bar-fill" style="width:'+Math.min(100,Math.round(beast.health/10))+'%"></div></div></div>'
          +'<div class="stat"><span class="stat-label">Species ID</span><span class="stat-value">'+beast.id+'</span></div>'
          +'<div class="stat"><span class="stat-label">Prefix / Suffix</span><span class="stat-value">'+beast.prefix+' / '+beast.suffix+'</span></div>'
        +'</div>'
        +'<div class="badges">'
          +(beast.shiny==1?'<span class="badge shiny">Shiny</span>':'<span class="badge">Regular</span>')
          +(beast.animated==1?'<span class="badge animated">Animated</span>':'<span class="badge">Static</span>')
          +(isLocked?'<span class="badge locked">Locked</span>':'')
        +'</div>'
      +'</div>'
      +'<div class="card-actions">'+lockBtnHtml+'<span class="card-status"></span></div>';

    // Wire up button
    const btn=card.querySelector(".lock-btn");
    const statusEl=card.querySelector(".card-status");
    if(isLocked){
      btn.onclick=()=>unlockBeast(tokenId,btn,statusEl);
    }else{
      btn.onclick=()=>lockBeast(tokenId,btn,statusEl);
    }
    return card;
  }

  // ── Load gallery ──────────────────────────────────────────────────────────
  async function loadBeasts(addr){
    const gallery=document.getElementById("gallery"),status=document.getElementById("status");
    const empty=document.getElementById("empty"),divider=document.getElementById("gallery-divider");
    const counter=document.getElementById("beast-count");
    gallery.innerHTML="";empty.classList.remove("visible");divider.classList.remove("visible");
    status.className="";status.innerHTML='<span class="spinner"></span> Fetching your beasts...';
    try{
      const tokens=await fetchOwnedTokens(addr);
      if(!tokens.length){status.innerHTML="";empty.classList.add("visible");return;}
      counter.textContent=tokens.length+" Beast"+(tokens.length!==1?"s":"")+" Found";
      divider.classList.add("visible");status.innerHTML="";
      for(let i=0;i<tokens.length;i++){
        const {id,locked}=tokens[i];
        const beast=await getBeastData(id);
        gallery.appendChild(renderCard(id,beast,locked,i));
      }
    }catch(err){console.error(err);status.className="error";status.textContent="Error: "+err.message;}
  }

  // ── Mint ──────────────────────────────────────────────────────────────────
  function rollBeast(){return{id:randInt(1,55),prefix:randInt(0,PREFIXES.length-1),suffix:randInt(0,SUFFIXES.length-1),level:randInt(1,50),health:randInt(50,1000),shiny:Math.random()<.05?1:0,animated:Math.random()<.10?1:0};}
  function updatePreview(b){
    pendingBeast=b;
    document.getElementById("preview-img").src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(makeSVG(b,"?"));
    document.getElementById("preview-name").textContent=beastLabel(b.id,b.prefix,b.suffix);
    document.getElementById("preview-stats").innerHTML='<div class="mini-stat">Level<span>'+b.level+'</span></div><div class="mini-stat">Health<span>'+b.health+'</span></div><div class="mini-stat">Species<span>#'+b.id+'</span></div><div class="mini-stat">Shiny<span>'+(b.shiny?"Yes":"No")+'</span></div>';
  }

  async function mintBeast(){
    if(!walletProvider||!walletAddress||!pendingBeast)return;
    const btn=document.getElementById("mint-btn"),ms=document.getElementById("mint-status"),b=pendingBeast;
    btn.disabled=true;btn.textContent="Summoning...";
    ms.className="";ms.innerHTML='<span class="spinner"></span> Awaiting wallet confirmation...';
    try{
      const account=walletProvider.account;
      if(!account)throw new Error("Wallet account not available");
      const result=await account.execute({contractAddress:NFT_CONTRACT,entrypoint:"mint",calldata:[walletAddress,toHex(b.id),toHex(b.prefix),toHex(b.suffix),toHex(b.level),toHex(b.health),toHex(b.shiny),toHex(b.animated)]});
      const tx=result.transaction_hash;
      ms.className="success";
      ms.innerHTML='Summoned! <a href="https://sepolia.voyager.online/tx/'+tx+'" target="_blank" style="color:var(--gold)">'+tx.slice(0,18)+'...</a>';
      updatePreview(rollBeast());btn.textContent="Summon Beast";btn.disabled=false;
      setTimeout(()=>loadBeasts(walletAddress),6000);
    }catch(err){
      console.error(err);ms.className="error";ms.textContent="Error: "+(err.message||"Transaction failed");
      btn.disabled=false;btn.textContent="Summon Beast";
    }
  }

  document.getElementById("reroll-btn").addEventListener("click",()=>{updatePreview(rollBeast());document.getElementById("mint-status").className="";document.getElementById("mint-status").textContent="";});
  document.getElementById("mint-btn").addEventListener("click",mintBeast);

  // ── Connect wallet ────────────────────────────────────────────────────────
  document.getElementById("connect-btn").addEventListener("click",async()=>{
    const btn=document.getElementById("connect-btn"),info=document.getElementById("wallet-info"),status=document.getElementById("status");
    btn.disabled=true;btn.textContent="Connecting...";
    try{
      const provider=window.starknet||window.starknet_braavos||window.starknet_argentX||window.braavos||window.argentX;
      if(!provider)throw new Error("No Starknet wallet found. Install Braavos or ArgentX.");
      await provider.enable({starknetVersion:"v5"});
      const address=provider.selectedAddress||provider.account?.address;
      if(!address)throw new Error("No account selected in wallet.");
      walletProvider=provider;walletAddress=address;
      btn.textContent="Connected";info.textContent=shortAddr(address);info.classList.add("visible");
      document.getElementById("mint-section").classList.add("visible");
      updatePreview(rollBeast());
      await loadBeasts(address);
    }catch(err){
      console.error(err);status.className="error";status.textContent="Error: "+err.message;
      btn.disabled=false;btn.textContent="Connect Wallet";
    }
  });
</script>
</body>
</html>
